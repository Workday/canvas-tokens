name: Release 
on:
  push:
    branches: 
      - main
      - prerelease/major
      - prerelease/minor
  workflow_dispatch:
    inputs:
      version:
        default: 'patch'
        description:
          'The version override: patch, minor or major'
        required: false
permissions:
  id-token: write  # Required for OIDC
  contents: write
jobs:
  release:
    # Only run if:
    # - The commit message does not contain `[skip release]`
    # - OR the workflow was manually triggered and has a `version` string
    if: ${{!contains(github.event.head_commit.message, '[skip release]') && !startsWith(github.event.head_commit.message, 'chore') && !startsWith(github.event.head_commit.message, 'Merge')}}
    runs-on: ubuntu-latest
    steps:
      ## First, we'll checkout the repository. We don't persist credentials because we need a
      ## Personal Access Token to push on a branch that is protected. See
      ## https://github.com/cycjimmy/semantic-release-action#basic-usage
      - uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0 # Used for conventional commit ranges
      
      - uses: actions/setup-node@v4
        with:
          node-version: 22.x
          # Do NOT set registry-url here - it creates token-based auth that conflicts with OIDC
      
      - uses: Workday/canvas-kit-actions/install@v1
        with:
          node_version: 22.x
      
      # Upgrade npm to 11.5.1+ for OIDC support (Node.js 22.x comes with npm 10.x)
      - name: Upgrade npm for OIDC support
        run: |
          npm install -g npm@latest
          npm --version
      
      # Configure npm for OIDC authentication with trusted publishers
      # OIDC authentication works automatically when:
      # 1. Package has trusted publisher configured on npm
      # 2. npm CLI version is 11.5.1+
      # 3. Workflow has id-token: write permission (already set above)
      # 4. Running in GitHub Actions environment (detected automatically)
      # IMPORTANT: Remove any token-based auth that setup-node might have created
      - name: Configure npm for OIDC (remove token-based auth)
        run: |
          # Remove any token-based auth that might have been set by setup-node
          # setup-node creates .npmrc in NPM_CONFIG_USERCONFIG location
          # OIDC will handle authentication automatically
          
          # Clean up token-based auth from user config (if set by setup-node)
          if [ -n "$NPM_CONFIG_USERCONFIG" ] && [ -f "$NPM_CONFIG_USERCONFIG" ]; then
            echo "Removing token-based auth from: $NPM_CONFIG_USERCONFIG"
            sed -i '/_authToken/d' "$NPM_CONFIG_USERCONFIG" || true
            sed -i '/\/\/registry\.npmjs\.org\/:_authToken/d' "$NPM_CONFIG_USERCONFIG" || true
          fi
          
          # Also clean up $HOME/.npmrc if it exists
          if [ -f "$HOME/.npmrc" ]; then
            echo "Removing token-based auth from: $HOME/.npmrc"
            sed -i '/_authToken/d' "$HOME/.npmrc" || true
            sed -i '/\/\/registry\.npmjs\.org\/:_authToken/d' "$HOME/.npmrc" || true
          fi
          
          # Configure registry for @workday scope (without token-based auth)
          echo "@workday:registry=https://registry.npmjs.org" >> $HOME/.npmrc
          
          # Ensure npm can detect GitHub Actions environment for OIDC
          echo "GitHub Actions environment detected: ${{ github.actions }}"
          echo "Repository: ${{ github.repository }}"
          echo "Workflow: ${{ github.workflow }}"
          echo ""
          echo "Final .npmrc contents:"
          cat $HOME/.npmrc || true
          if [ -n "$NPM_CONFIG_USERCONFIG" ] && [ -f "$NPM_CONFIG_USERCONFIG" ]; then
            echo ""
            echo "NPM_CONFIG_USERCONFIG contents:"
            cat "$NPM_CONFIG_USERCONFIG" || true
          fi
      
      # Verify npm version (OIDC requires npm 11.5.1+)
      - name: Verify npm version and OIDC setup
        run: |
          npm_version=$(npm --version)
          echo "Current npm version: $npm_version"
          
          # Check if version is 11.5.1 or higher
          # Compare version strings: extract major.minor.patch and compare
          major=$(echo "$npm_version" | cut -d. -f1)
          minor=$(echo "$npm_version" | cut -d. -f2)
          patch=$(echo "$npm_version" | cut -d. -f3 | sed 's/[^0-9].*//')
          
          if [ "$major" -lt 11 ] || ([ "$major" -eq 11 ] && ([ "$minor" -lt 5 ] || ([ "$minor" -eq 5 ] && [ "$patch" -lt 1 ]))); then
            echo "Error: npm version must be 11.5.1+ for OIDC support. Current: $npm_version"
            exit 1
          fi
          
          echo "✓ npm version $npm_version supports OIDC"
          echo "✓ GitHub Actions OIDC token should be available via ACTIONS_ID_TOKEN_REQUEST_TOKEN"
          if [ -z "$ACTIONS_ID_TOKEN_REQUEST_TOKEN" ]; then
            echo "Warning: ACTIONS_ID_TOKEN_REQUEST_TOKEN not set - OIDC may not work"
          else
            echo "✓ OIDC token environment variable is set"
          fi
      
      - name: Config git user
        shell: bash
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"
      
      - name: Pull prerelease branch
        if: ${{  inputs.version == 'minor' || inputs.version == 'major' }}
        run: |
          git pull origin prerelease/${{ inputs.version }}
      
      - name: Set version output
        id: set_version
        run: |
          VERSION=""
          BRANCH="${{github.ref_name}}"
          COMMIT_MSG=$(git log -1 --pretty=%s)
      
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
          elif [[ "$BRANCH" == prerelease/* ]]; then
            VERSION="${BRANCH#prerelease/}"
          elif [[ "$BRANCH" == "main" ]]; then
            if [[ "$COMMIT_MSG" == feat* ]]; then
              VERSION="minor"
            elif [[ "$COMMIT_MSG" == fix* ]]; then
              VERSION="patch"
            fi
          fi
      
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
      
      - name: Get preid
        id: get_preid
        if: ${{ contains(github.ref_name, 'prerelease/') && steps.set_version.outputs.version }}
        run: |
          VERSION="${{ steps.set_version.outputs.version }}"
          if [[ "$VERSION" == "major" ]]; then
            echo "preid=alpha" >> "$GITHUB_OUTPUT"
          elif [[ "$VERSION" == "minor" ]]; then
            echo "preid=beta" >> "$GITHUB_OUTPUT"
          fi
      
      # Test npm authentication with OIDC before publishing
      - name: Test npm OIDC authentication
        if: ${{ steps.set_version.outputs.version }}
        run: |
          echo "Testing npm OIDC authentication..."
          echo "Environment variables:"
          echo "  GITHUB_ACTIONS: ${GITHUB_ACTIONS:-not set}"
          echo "  GITHUB_REPOSITORY: ${GITHUB_REPOSITORY:-not set}"
          echo "  ACTIONS_ID_TOKEN_REQUEST_TOKEN: ${ACTIONS_ID_TOKEN_REQUEST_TOKEN:+set (hidden)}"
          echo "  ACTIONS_ID_TOKEN_REQUEST_URL: ${ACTIONS_ID_TOKEN_REQUEST_URL:+set}"
          echo ""
          
          # Verify npm can access the registry (this tests OIDC authentication)
          # For existing packages, this will work if OIDC is configured correctly
          # For new packages, this might fail but that's OK - the publish will still work
          echo "Testing npm registry access..."
          npm whoami --registry=https://registry.npmjs.org || {
            echo "Warning: 'npm whoami' failed - this might be OK if OIDC is configured for publishing only"
            echo "OIDC authentication will be attempted during publish"
          }
          
          # Try to view the package (this requires authentication for private packages)
          # For public packages, this works without auth, but for scoped packages it might require auth
          npm view @workday/canvas-tokens-web 2>&1 || echo "Note: Package view failed (may not exist or require auth)"
          
          echo "✓ npm authentication test completed"
      
      - uses: Workday/canvas-kit-actions/do-release@v1
        if: ${{ steps.set_version.outputs.version }}
        id: release
        with:
          ghToken: ${{ secrets.GH_RW_TOKEN }}
          package: "@workday/canvas-tokens-web"
          version: ${{ steps.set_version.outputs.version }}
          buildScript: echo "Building..."
          packagePath: packages/canvas-tokens-web
          prerelease: ${{ contains(github.ref_name, 'prerelease/') }}
          preid: ${{ steps.get_preid.outputs.preid }}
          skipGithubRelease: ${{ contains(github.ref_name, 'prerelease/') }}
          releaseScript: |
            # Publish using npm directly with OIDC authentication
            # OIDC authentication works automatically when:
            # 1. npm 11.5.1+ is installed
            # 2. Trusted publisher is configured on npm
            # 3. Running in GitHub Actions with id-token: write permission
            echo "=== OIDC Authentication Debug Info ==="
            echo "GitHub Actions Environment:"
            echo "  GITHUB_ACTIONS: ${GITHUB_ACTIONS:-not set}"
            echo "  GITHUB_REPOSITORY: ${GITHUB_REPOSITORY:-not set}"
            echo "  GITHUB_WORKFLOW: ${GITHUB_WORKFLOW:-not set}"
            echo "  ACTIONS_ID_TOKEN_REQUEST_TOKEN: ${ACTIONS_ID_TOKEN_REQUEST_TOKEN:+set (hidden)}"
            echo "  ACTIONS_ID_TOKEN_REQUEST_URL: ${ACTIONS_ID_TOKEN_REQUEST_URL:+set}"
            echo ""
            echo "npm Configuration:"
            echo "  npm version: $(npm --version)"
            echo "  registry: $(npm config get registry)"
            echo ""
            
            # Ensure we're in the repo root
            if [ ! -f "package.json" ] || [ ! -d "packages/canvas-tokens-web" ]; then
              echo "Error: Not in repository root"
              exit 1
            fi
            
            # Navigate to package directory
            cd packages/canvas-tokens-web
            
            if [ ! -f "package.json" ]; then
              echo "Error: package.json not found in packages/canvas-tokens-web"
              exit 1
            fi
            
            echo "Publishing from: $(pwd)"
            PACKAGE_VERSION=$(node -p "require('./package.json').version")
            PACKAGE_NAME=$(node -p "require('./package.json').name")
            echo "Package: $PACKAGE_NAME@$PACKAGE_VERSION"
            echo ""
            
            # Determine tag based on version (alpha/beta for prerelease, latest otherwise)
            if [[ "$PACKAGE_VERSION" == *"-alpha."* ]]; then
              TAG="alpha"
            elif [[ "$PACKAGE_VERSION" == *"-beta."* ]]; then
              TAG="beta"
            else
              TAG="latest"
            fi
            
            echo "Publishing with tag: $TAG"
            echo "Using OIDC authentication (trusted publisher)"
            echo ""
            echo "=== Publishing ==="
            
            # Publish with OIDC authentication
            # --provenance is optional - adds provenance attestations for supply chain security
            # OIDC authentication works without it, but provenance is recommended for security
            npm publish --provenance --access public --tag "$TAG"
          skipTagsPush: false
