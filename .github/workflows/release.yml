name: Release 
on:
  push:
    branches: 
      - main
      - prerelease/major
      - prerelease/minor
  workflow_dispatch:
    inputs:
      version:
        default: 'patch'
        description:
          'The version override: patch, minor or major'
        required: false
permissions:
  id-token: write  # Required for OIDC
  contents: write
jobs:
  release:
    # Only run if:
    # - The commit message does not contain `[skip release]`
    # - OR the workflow was manually triggered and has a `version` string
    if: ${{!contains(github.event.head_commit.message, '[skip release]') && !startsWith(github.event.head_commit.message, 'chore') && !startsWith(github.event.head_commit.message, 'Merge')}}
    runs-on: ubuntu-latest
    steps:
      ## First, we'll checkout the repository. We don't persist credentials because we need a
      ## Personal Access Token to push on a branch that is protected. See
      ## https://github.com/cycjimmy/semantic-release-action#basic-usage
      - uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0 # Used for conventional commit ranges
      
      - uses: actions/setup-node@v4
        with:
          node-version: 22.x
          registry-url: 'https://registry.npmjs.org'
          # OIDC authentication is handled automatically by npm when using trusted publishers
      
      - uses: Workday/canvas-kit-actions/install@v1
        with:
          node_version: 22.x
      
      # Upgrade npm to 11.5.1+ for OIDC support (Node.js 22.x comes with npm 10.x)
      - name: Upgrade npm for OIDC support
        run: |
          npm install -g npm@latest
          npm --version
      
      # Configure npm for OIDC authentication with trusted publishers
      # OIDC authentication works automatically when:
      # 1. Package has trusted publisher configured on npm
      # 2. npm CLI version is 11.5.1+
      # 3. Workflow has id-token: write permission (already set above)
      # 4. Running in GitHub Actions environment (detected automatically)
      - name: Configure npm for OIDC
        run: |
          echo "@workday:registry=https://registry.npmjs.org" >> $HOME/.npmrc
          echo "//registry.npmjs.org/:always-auth=true" >> $HOME/.npmrc
          # Ensure npm can detect GitHub Actions environment for OIDC
          echo "GitHub Actions environment detected: ${{ github.actions }}"
          echo "Repository: ${{ github.repository }}"
          echo "Workflow: ${{ github.workflow }}"
      
      # Verify npm version (OIDC requires npm 11.5.1+)
      - name: Verify npm version and OIDC setup
        run: |
          npm_version=$(npm --version)
          echo "Current npm version: $npm_version"
          
          # Check if version is 11.5.1 or higher
          # Compare version strings: extract major.minor.patch and compare
          major=$(echo "$npm_version" | cut -d. -f1)
          minor=$(echo "$npm_version" | cut -d. -f2)
          patch=$(echo "$npm_version" | cut -d. -f3 | sed 's/[^0-9].*//')
          
          if [ "$major" -lt 11 ] || ([ "$major" -eq 11 ] && ([ "$minor" -lt 5 ] || ([ "$minor" -eq 5 ] && [ "$patch" -lt 1 ]))); then
            echo "Error: npm version must be 11.5.1+ for OIDC support. Current: $npm_version"
            exit 1
          fi
          
          echo "✓ npm version $npm_version supports OIDC"
          echo "✓ GitHub Actions OIDC token should be available via ACTIONS_ID_TOKEN_REQUEST_TOKEN"
          if [ -z "$ACTIONS_ID_TOKEN_REQUEST_TOKEN" ]; then
            echo "Warning: ACTIONS_ID_TOKEN_REQUEST_TOKEN not set - OIDC may not work"
          else
            echo "✓ OIDC token environment variable is set"
          fi
      
      - name: Config git user
        shell: bash
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"
      
      - name: Pull prerelease branch
        if: ${{  inputs.version == 'minor' || inputs.version == 'major' }}
        run: |
          git pull origin prerelease/${{ inputs.version }}
      
      - name: Set version output
        id: set_version
        run: |
          VERSION=""
          BRANCH="${{github.ref_name}}"
          COMMIT_MSG=$(git log -1 --pretty=%s)
      
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
          elif [[ "$BRANCH" == prerelease/* ]]; then
            VERSION="${BRANCH#prerelease/}"
          elif [[ "$BRANCH" == "main" ]]; then
            if [[ "$COMMIT_MSG" == feat* ]]; then
              VERSION="minor"
            elif [[ "$COMMIT_MSG" == fix* ]]; then
              VERSION="patch"
            fi
          fi
      
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
      
      - name: Get preid
        id: get_preid
        if: ${{ contains(github.ref_name, 'prerelease/') && steps.set_version.outputs.version }}
        run: |
          VERSION="${{ steps.set_version.outputs.version }}"
          if [[ "$VERSION" == "major" ]]; then
            echo "preid=alpha" >> "$GITHUB_OUTPUT"
          elif [[ "$VERSION" == "minor" ]]; then
            echo "preid=beta" >> "$GITHUB_OUTPUT"
          fi
      
      # Test npm authentication with OIDC before publishing
      - name: Test npm OIDC authentication
        if: ${{ steps.set_version.outputs.version }}
        run: |
          echo "Testing npm authentication..."
          # Try to access the package to verify authentication works
          # This will fail if OIDC isn't working, but won't fail if package doesn't exist (which is OK for first publish)
          npm view @workday/canvas-tokens-web || echo "Package may not exist yet (OK for first publish)"
          echo "✓ npm authentication test completed"
      
      - uses: Workday/canvas-kit-actions/do-release@v1
        if: ${{ steps.set_version.outputs.version }}
        id: release
        with:
          ghToken: ${{ secrets.GH_RW_TOKEN }}
          package: "@workday/canvas-tokens-web"
          version: ${{ steps.set_version.outputs.version }}
          buildScript: echo "Building..."
          packagePath: packages/canvas-tokens-web
          prerelease: ${{ contains(github.ref_name, 'prerelease/') }}
          preid: ${{ steps.get_preid.outputs.preid }}
          skipGithubRelease: ${{ contains(github.ref_name, 'prerelease/') }}
          releaseScript: |
            # npm will automatically use OIDC in GitHub Actions when:
            # 1. Package has trusted publisher configured on npm
            # 2. npm CLI version is 11.5.1+
            # 3. Workflow has id-token: write permission
            # Note: changeset publish doesn't support --provenance flag directly,
            # but npm should still use OIDC for authentication automatically
            # The --access public flag is required for scoped packages to be published publicly
            yarn changeset publish --access public
          skipTagsPush: false
